"use strict";

var assert = require('assert');
var Game = require('../../src/node_modules/models/Game');
var Player = require('../../src/node_modules/models/Player');
var PongUtils = require('../../src/node_modules/PongUtils');

var TestUtils = module.exports;

TestUtils.getPlayer = function*(options)
{
	var defaults =
	{
		name: 'Test Player ' + playersCreated,
		email: 'test' + playersCreated + '@test.com',
		rating: parseInt(Math.random() * 100),
		player_type_id: Player.types.pendingApproval 
	};
	var settings = PongUtils.extend({}, defaults, options);
	
	var p = new Player();
	p.name = settings.name;
	p.email = settings.email;
	p.rating = settings.rating;
	p.player_type_id = settings.player_type_id;
	
	yield p.save();
	assert(p.id, 'player should have been saved');
	playersCreated++;
	
	return p;
};

var playersCreated = 0;

/**
 * Creates players and saves the resulting game.
 * @return {Game}
 */
TestUtils.getGame = function*(options)
{
	var defaults = 
	{
		game_type_id: Game.types.singles,
		
		team1: null,
		team1Score:11,
		
		team2: null,
		team2Score:8,
		
		expectsError: false
	};
	
	var settings = PongUtils.extend({}, defaults, options);
	
	var g = new Game();
	g.game_type_id = settings.game_type_id;
	
	var getPlayerArray = function*()
	{
		var a = [];
		a.push(yield TestUtils.getPlayer());
		if (g.isDoublesGame)
		{
			a.push(yield TestUtils.getPlayer());
		}
		return a;
	};
	
	g.team1 = settings.team1;
	if (!g.team1) g.team1 = yield getPlayerArray();
	g.team1Score = settings.team1Score;
	
	g.team2 = settings.team2;
	if (!g.team2) g.team2 = yield getPlayerArray();
	g.team2Score = settings.team2Score;
	
	g.created_by_player_id = g.team1[0].id;
	
	try
	{
		yield g.save();
	}
	catch (e)
	{
		if (settings.expectsError) 
			return e.message;
		
		throw new Error(e);
	}
	
	assert(g.id, 'game should have been saved');
	return g;
};

TestUtils.log = function(msg)
{
	console.log('\n' + msg);
};