"use strict";

var Sql = require('Sql');

var recentGamesLimit = 5;

var RecentGames = module.exports;

/*
    returns the most recent games
 */
RecentGames.getRecentGames = function*(recentGamesLimit)
{
    recentGamesLimit = (!recentGamesLimit) ? 5 : recentGamesLimit; // limit to 5 if not set

    var recentGamesFake = [
        {"winner": "George", "winnerScore": "11",  "loser": "Kevin", "loserScore": "8", "time": "2014-08-29 18:35:22"},
        {"winner": "George", "winnerScore": "11",  "loser": "Jarrod", "loserScore": "3", "time": "2014-08-28 15:23:15"},
        {"winner": "Bret", "winnerScore": "11",  "loser": "Amber", "loserScore": "6", "time": "2014-08-30 13:45:22"},
        {"winner": "Amber", "winnerScore": "11",  "loser": "Jarrod", "loserScore": "7", "time": "2014-08-31 11:43:05"},
        {"winner": "Jarrod", "winnerScore": "11",  "loser": "Kevin", "loserScore": "4", "time": "2014-09-01 09:85:42"},
        {"winner": "Kevin", "winnerScore": "11",  "loser": "Amber", "loserScore": "5", "time": "2014-09-01 12:29:32"}
    ];

    var recentGames = [];

    yield Sql.using(function*(db)
    {
        var allGames = yield db.query(
            'SELECT G.played_date, G.game_type_id, GP.* '+
            'FROM games G '+
            'JOIN games_players GP ON G.id = GP.game_id '+
            'ORDER BY G.played_date, G.id DESC ' +
            'LIMIT ' + recentGamesLimit
        );
        // nothing to do
        if(allGames.rowCount == 0) {
            console.log('nothing to do');
            return;
        }

        var allPlayers = yield db.query('SELECT * FROM players');

        for(var i = 0; i < allGames.rowCount; i+=2) {
            var gp1 = allGames.rows[i];
            var gp2 = allGames.rows[i+1];

            if(gp1.game_id != gp2.game_id) throw ("Game ids don't match, which shouldn't be possible; "+gp1.game_id+" vs "+gp2.game_id);

            var p1 = allPlayers.rows[gp1.player_id-1];
            var p2 = allPlayers.rows[gp2.player_id-1];

            var winner = gp1.score > gp2.score ? p1.name : p2.name;
            var loser = gp1.score > gp2.score ? p2.name : p1.name;
            var winnerScore = gp1.score > gp2.score ? gp1.score : gp2.score;
            var loserScore = gp1.score > gp2.score ? gp2.score : gp1.score;
            var wonBy = Math.max(gp1.score, gp2.score) - Math.min(gp1.score, gp2.score);
            var outOf = gp1.game_type_id == 1 ? 11 : 21;

            recentGames.push({"winner": winner, "winnerScore": winnerScore,  "loser": loser, "loserScore": loserScore, "time": allGames.rows[i].played_date})
            //{"winner": "George", "winnerScore": "11",  "loser": "Kevin", "loserScore": "8", "time": "2014-08-29 18:35:22"},
        }

    });

    return recentGames;
};
