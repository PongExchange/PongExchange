"use strict";

/* -------------------------------------------------------------------
 * Require Statements << Keep in alphabetical order >>
 * ---------------------------------------------------------------- */

var PlayerStats = require('models/PlayerStats');
var PongUtils = require('PongUtils');
var Sql = require('Sql');
var Url = require('url');

/* =============================================================================
 * 
 * Player
 *  
 * ========================================================================== */

module.exports = Player;

var DEFAULT_ROW = 
{
	id: 0,
	name: null,
	email: null,
	affiliation: null,
	rating: 0,
	google_id: null,
	google_profile: null,
	image_url: null,
	bio: null
};

/**
 * A ping pong player and user of this app.
 * @param databaseRow A query result row that minimally contains the id and name column values
 * @constructor
 */
function Player (databaseRow)
{
	// not all database rows will have all the columns, resulting in undefined values overwriting default nulls
	var row = databaseRow ? PongUtils.extend({}, DEFAULT_ROW, databaseRow) : DEFAULT_ROW;
	
	// database columns; some rows might have prefixed any player columns with `player_`
	this.id = row.player_id || row.id;
	this.name = row.player_name || row.name;
	this.email = row.player_email || row.email;
	this.affiliation = row.affiliation;
	this.rating = row.rating;
	this.googleId = row.google_id;
	this.googleProfile = row.google_profile;
	this.imageUrl = row.player_image_url || row.image_url;
	this.bio = row.bio;
	
	/**
	 * @member {PlayerStats}
	 */
	this.stats = null;
}

/* -------------------------------------------------------------------
 * Getters / Setters
 * ---------------------------------------------------------------- */

Object.defineProperty(Player.prototype, 'profileUrl', {
	get: function () { return '/players/' + this.id + '/' + PongUtils.slugify(this.name); }
});

/* -------------------------------------------------------------------
 * Static Methods << Keep in alphabetical order >>
 * ---------------------------------------------------------------- */

/**
 * 
 * @param profile The profile object we get from the google API.
 * @return {Player}
 */
Player.fromGoogle = function * (profile)
{
	var p = new Player();
	p.name = profile.displayName;
	p.email = profile.emails[0].value; // todo: might want to look through more than just the first email
	p.googleId = profile.id;
	p.googleProfile = profile;
	if (profile.image && profile.image.url)
	{
		let url = Url.parse(profile.image.url);
		delete url.search;
		if (url.query)
			delete url.query.sz; // delete the size query argument
		p.imageUrl = Url.format(url);
	}
	
	var existingPlayer = yield Sql.using(function * (db)
	{
		var ep;
		// check if this user already exists
		var res = yield db.query('select * from players where google_id = $1 or email = $2;', [ p.googleId, p.email ]);
		if (res.rows.length === 0)
			return null;
		
		// we got some sort of match
		var row;
		for (var i = 0; i < res.rows.length; i++)
		{
			row = res.rows[i];
			if (p.googleId === row.google_id)
			{
				// looks like this player already exists, check if we need to update their profile image
				ep = new Player(row);
				if (!ep.imageUrl ||
					(ep.imageUrl !== p.imageUrl && ep.googleProfile && ep.googleProfile.image && ep.imageUrl === ep.googleProfile.image.url))
				{
					ep.imageUrl = p.imageUrl;
					yield db.query('update players set image_url = $1 where id = $2;', [ ep.imageUrl, ep.id ]);
				}
				return ep;
			}
		}

		// must be an email match - let's add a google profile ID to the existing player
		ep = new Player(res.rows[0]);
		if (!ep.googleId)
		{
			ep.googleId = p.googleId;
			ep.googleProfile = p.googleProfile;
			yield ep.save();

			return ep;
		}
	});
	
	if (existingPlayer)
		return existingPlayer;
	
	yield p.save();
	return p;
};

/**
 * Gets all players in the database.
 * @return {Player[]}
 */
Player.getAll = function*()
{
	return yield Sql.using(function*(db)
	{
		var dbResult = yield db.query('SELECT * FROM players');
		var len = dbResult.rows.length;
		var players = new Array(len);
		for (var i = 0; i < len; i++)
			players[i] = new Player(dbResult.rows[i]);
		
		return players;
	});
};

/**
 * Returns all players in the database with their {@link Player#stats} already loaded
 * @type {Player[]}
 */
Player.getAllWithStats = function*()
{
	var players = yield Player.getAll();
	var stats = yield PlayerStats.getAllKeyedByPlayerId();
	
	for (var i = 0; i < players.length; i++)
	{
		players[i].stats = stats[players[i].id] || new PlayerStats(); 
	}
	
	return players;
};

/**
 * @return {Player} with parameter 'id' or null if not found
 */
Player.getById = function*(id)
{
	var player = null;
	if (typeof id != 'number' || id === 0) return player;
	
	yield Sql.using(function*(db)
	{
		var dbResult = yield db.query('select * from players where id = $1', [id]);
		if (dbResult.rowCount === 1)
		{
			player = new Player(dbResult.rows[0]);
		}
	});
	
	return player; 
};

/**
 * @param email
 * @return {Player} with parameter 'email' or null if not found
 */
Player.getByEmail = function*(email)
{
	var player = null;
	if (typeof email != 'string' || email.length == 0) return player;
	
	yield Sql.using(function*(db)
	{
		var dbResult = yield db.query('select * from players where email = $1', [email.toLowerCase()]);
		
		// TODO: make unique constraint on email
		if (dbResult.rowCount === 1)
		{
			player = new Player(dbResult.rows[0]);
		}
	});
	
	return player;
};


/* -------------------------------------------------------------------
 * Prototype Methods << Keep in alphabetical order >>
 * ---------------------------------------------------------------- */

/**
 * refreshes the {@link Player#stats} object from the database
 */
Player.prototype.loadStats = function*()
{
	this.stats = yield PlayerStats.getForPlayerId(this.id);
};

/**
 * Upserts this Player to the db
 * @return {boolean} indicating if the operation was successful
 */
Player.prototype.save = function * ()
{
	// emails should always be lower-cased, localization be damned for now
	if (this.email && this.email !== this.email.toLowerCase())
	{
		this.email = this.email.toLowerCase();
	}

	if (!this.name)
	{
		this.name = this.email;
	}
	
	return yield Sql.using(/**@param db {SqlClient}*/function * (db)
	{
		var sql, res;
		var params = [ this.name, this.email, this.affiliation, this.rating, this.googleId, this.googleProfile, this.imageUrl, this.bio ];
		if (!this.id)
		{
			// insert
			sql = 'insert into players (name, email, affiliation, rating, google_id, google_profile, image_url, bio) values ($1, $2, $3, $4, $5, $6, $7, $8) returning id;';
			res = yield db.query(sql, params);
			this.id = res.rows[0].id;
			return true;
		}
		
		// update
		sql = 'update players set name=$1, email=$2, affiliation=$3, rating=$4, google_id=$5, google_profile=$6, image_url=$7, bio=$8 where id = $9';
		params.push(this.id);
		res = yield db.query(sql, params);
		return res.rowCount === 1;
		
	}.bind(this));
};
