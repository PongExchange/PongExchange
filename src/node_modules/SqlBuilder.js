"use strict";
/* -------------------------------------------------------------------
 * Require Statements << Keep in alphabetical order >>
 * ---------------------------------------------------------------- */

var PongUtils = require('PongUtils');
var Sql = require('Sql');

/* =============================================================================
 * 
 * SqlBuilder - PARTIAL port of https://github.com/StackExchange/dapper-dot-net/tree/master/Dapper.SqlBuilder
 * 
 * SPECIFICALLY FOR POSTGRES
 * 
 * NO SUPPORT FOR:
 * inclusive OR, e.g. "where (a = b OR c = d)"
 * initial template parameters (i've never needed them)
 * most clauses
 * ========================================================================== */

module.exports = SqlBuilder;

function SqlBuilder()
{
	this.name_clauses = { };
	this.clauseCount = 0;
}

/* -------------------------------------------------------------------
 * SqlBuilder - Static Methods << Keep in alphabetical order >>
 * ---------------------------------------------------------------- */

/* -------------------------------------------------------------------
 * SqlBuilder - Getters / Setters
 * ---------------------------------------------------------------- */

/* -------------------------------------------------------------------
 * SqlBuilder - Prototype Methods << Keep in alphabetical order >>
 * ---------------------------------------------------------------- */

/**
 * returns a new {Template} for this {SqlBuilder} with the parameter sql as its building block
 * @param sql {String} e.g. 'select * from table --[SqlBuilder: where]'
 * @return {Template}
 */
SqlBuilder.prototype.newTemplate = function(sql)
{
	return new Template(this, sql);
};

/**
 * adds a clause to the --[SqlBuilder: where] placeholder in the template's sql
 * 
 * @param sql {String} e.g. 'a.id = @id'
 * @param params {Object} e.g. { id: 5 }
 */
SqlBuilder.prototype.where = function(sql, params)
{
	addClause({ name: 'where', joiner: ' and ', prefix: 'where ' }, this, sql, params);
};

/* -------------------------------------------------------------------
 * SqlBuilder - Private Methods << Keep in alphabetical order >>
 * ---------------------------------------------------------------- */

function addClause(options, builder, sql, params)
{
	var defaults =
	{
		name: null,
		joiner: '',
		prefix: '',
		postfix: '\n'
	};
	var settings = PongUtils.extend({}, defaults, options),
		clauses = builder.name_clauses[settings.name];
	
	if (!clauses)
	{
		clauses = new Clauses(settings.joiner, settings.prefix, settings.postfix);
		builder.name_clauses[settings.name] = clauses;
	}
	
	clauses.array.push(new Clause(sql, params));
	builder.clauseCount++;
}

/**
 * One or more sql statements associated with a {SqlBuilder}.
 * 
 * For example, a builder could have one sql query for selecting counts and another for selecting full records.
 * In this case, there would be two templates created, and the same paramters added to the builder would apply to
 * both templates.
 * 
 * @param builder {SqlBuilder} the builder to add clauses and parameters to
 * @param sql {String} the specific sql query (or variant)
 * @constructor
 */
function Template (builder, sql)
{
	this.builder = builder;
	this.initSql = sql;
	this.resolvedClauseCount = -1; // when this doesn't match builder.clauseCount, we'll resolve
	
	this.resolvedSql;
	this.resolvedParams;
}

/* -------------------------------------------------------------------
 * Template - Static Methods << Keep in alphabetical order >>
 * ---------------------------------------------------------------- */

/* -------------------------------------------------------------------
 * Template - Getters / Setters
 * ---------------------------------------------------------------- */
Object.defineProperties(Template.prototype,
{
	/**
	 * ready-to-run sql with ordinal parameters
	 */
	sql: {
		get: function () { resolveSql(this); return this.resolvedSql; }
	},
	/**
	 * ordinal parameter array for {Template} sql
	 */
	params: {
		get: function() { resolveSql(this); return this.resolvedParams; }
	}
});

/* -------------------------------------------------------------------
 * Template - Prototype Methods << Keep in alphabetical order >>
 * ---------------------------------------------------------------- */

/**
 * returns a database query result for the execution of {Template} sql and params 
 */
Template.prototype.query = function*()
{
	return yield Sql.using(function*(db)
	{
		return yield db.query(this.sql, this.params);
	}.bind(this));
};

/* -------------------------------------------------------------------
 * Template - Private Methods << Keep in alphabetical order >>
 * ---------------------------------------------------------------- */

/**
 * prepares sql for execution 
 * @param t {Template}
 */
function resolveSql(t)
{
	if (t.resolvedClauseCount == t.builder.clauseCount) return;
	
	t.resolvedSql = t.initSql;
	t.resolvedParams = { };

	for (var name in t.builder.name_clauses)
	{
		var clauses = t.builder.name_clauses[name];
		var r = new RegExp('--\\[SqlBuilder:\\s?' + name + '\\]', 'i');
		t.resolvedSql = t.resolvedSql.replace(r, clauses.resolveSql(t.resolvedParams));
	}
}


/* -------------------------------------------------------------------
 * Private Classes
 * ---------------------------------------------------------------- */

function Clause(sql, params)
{
	this.sql = sql;
	this.params = params;
}

function Clauses(joiner, prefix, postfix)
{
	this.array = [];
	
	this.joiner = joiner;
	this.prefix = prefix;
	this.postfix = postfix;
}

Clauses.prototype.resolveSql = function(params)
{
	var sqlArray = [];
	
	this.array.forEach(function(c)
	{
		PongUtils.extend(params, c.params);
		sqlArray.push(c.sql);
	});
	
	return this.prefix + sqlArray.join(this.joiner) + this.postfix;
};