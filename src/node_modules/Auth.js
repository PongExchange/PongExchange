"use strict";

var koaPassport = require('koa-passport');
var co = require('co');

var Config = require('Config');
var Player = require('./models/Player');


// see http://passportjs.org/guide/configure/
koaPassport.serializeUser(function(player, done)
{
	// just the id will be stored in session cookie
	done(null, player.id);
});

koaPassport.deserializeUser(function(id, done)
{
	co(function*()
	{
		var player = yield Player.getById(id);
		return player || false;
	})(done);
});

var GoogleStrategy = require('passport-google').Strategy;
koaPassport.use(new GoogleStrategy({
		returnURL: Config.web.getAbsoluteUri() + '/auth/google/callback',
		realm: Config.web.getAbsoluteUri()
	},
	function (identifier, profile, done)
	{
		co(function*()
		{
			var email = profile && profile.emails && profile.emails.length > 0 ? profile.emails[0].value : '';
			var player = yield Player.getByEmail(email);
			
			console.log(email);
			
			if (!player)
			{
				var newId = yield Player.insert({ name: profile.displayName, email: email });
				player = yield Player.getById(newId);
			}
			
			return player;
		})(done);
	})
);